# 提升智谱AI模型提取准确性指南

## 📊 当前问题诊断

### 1. 提取粒度不匹配

**算法提取（细粒度）：**
```json
{
  "category": "人员要求(6分)",
  "label": "应答人须提供...期间国内承接类似...合同业绩案例：50万(含)以下不得分；50-100万(含)得1分..."
}
```

**智谱AI提取（粗粒度）：**
```json
{
  "category": "资格评审",
  "content": "检查类似项目业绩证明材料是否满足要求"
}
```

**问题**：智谱AI过度概括，丢失了具体的评分标准和细节。

### 2. 分类体系差异

| 算法分类 | 智谱AI分类 | 匹配度 |
|---------|-----------|--------|
| 封面检查 | 形式评审 | ⚠️ 部分 |
| 资格要求 | 资格评审 | ⚠️ 部分 |
| 人员要求(6分) | 资格评审 | ❌ 不匹配 |
| 企业业绩(8分) | 资格评审 | ❌ 不匹配 |
| 安全生产管理方案(3分) | 技术评审 | ⚠️ 部分 |

### 3. 匹配算法过于简单

```python
# 当前：简单的关键词匹配
if len(common_words) >= 2:  # 太宽松
    matched = True
```

**问题**：
- "检查"、"要求"等高频词导致误匹配
- 无法理解语义相似性
- 阈值固定，缺乏灵活性

## 🚀 改进方案

### 方案1：优化Prompt工程（✅ 已实施）

#### 改进点：

1. **明确提取粒度**
   ```prompt
   **提取要求：**
   1. 细粒度提取：尽量保持原文的具体表述，不要过度概括
   2. 保留原文术语：使用招标文件中的原始术语和分类名称
   ```

2. **提供示例格式**
   ```prompt
   {{
     "category": "具体分类名称（如：人员要求(6分)、企业业绩(8分)）",
     "label": "检查项的简短描述（保持原文表述）",
     "content": "详细的检查要求说明"
   }}
   ```

3. **增加文本长度**
   ```python
   # 从10,000字符提升到15,000字符
   document_text = extract_pdf_text(pdf_path, max_chars=15000)
   ```

4. **明确分类参考**
   ```prompt
   **分类参考**：
   - 封面检查、签字盖章
   - 报价唯一性、资格要求
   - 人员要求、企业业绩、企业资质
   ```

### 方案2：改进匹配算法（✅ 已实施）

```python
def calculate_text_similarity(text1: str, text2: str) -> float:
    """计算文本相似度（Jaccard相似度）"""
    words1 = set(text1.lower().split())
    words2 = set(text2.lower().split())

    intersection = words1 & words2
    union = words1 | words2

    return len(intersection) / len(union) if union else 0.0
```

**改进点：**
- ✅ 使用Jaccard相似度代替简单关键词计数
- ✅ 添加相似度阈值（0.3）
- ✅ 类别匹配加分机制
- ✅ 显示最佳匹配对和相似度分数

### 方案3：Few-Shot Learning（推荐）

在Prompt中提供示例：

```python
prompt = """
请参考以下提取示例：

**示例1：**
原文：应答人须提供...50万(含)以下不得分；50-100万(含)得1分...
提取结果：
{{
  "category": "人员要求(6分)",
  "label": "应答人须提供...期间国内承接类似...合同业绩案例",
  "content": "50万(含)以下不得分；50-100万(含)得1分；100-150万(含)得2分...",
  "score": "6分"
}}

**示例2：**
原文：具有ISO 9001质量管理体系认证证书，得1分...
提取结果：
{{
  "category": "企业资质(3分)",
  "label": "具有ISO 9001质量管理体系认证证书",
  "content": "得1分；具有ISO 14001环境管理体系认证证书，得1分...",
  "score": "3分"
}}

现在请分析以下招标文件：
"""
```

### 方案4：使用更好的模型

```python
# 升级到更强的模型
response = client.chat.completions.create(
    model="glm-4-plus",  # 或 "glm-4-0520"
    messages=[...],
    temperature=0.1
)
```

**模型对比：**
- `glm-4.7`：标准性能，速度快
- `glm-4-plus`：更强理解能力，适合复杂任务
- `glm-4-0520`：最新版本，效果最好

### 方案5：多阶段提取

```python
def extract_checkpoints_multi_stage(document_text: str):
    """多阶段提取策略"""

    # 阶段1：粗提取 - 获取所有可能的检查点
    prompt_stage1 = """
    请识别招标文件中所有提到"检查"、"要求"、"须提供"等关键词的地方。
    返回所有相关的段落或句子。
    """
    coarse_result = call_api(prompt_stage1)

    # 阶段2：精提取 - 对每个检查点进行详细提取
    prompt_stage2 = f"""
    基于以下粗提取结果：
    {coarse_result}

    请对每个检查点进行详细提取，包括：
    1. 分类名称（保持原文）
    2. 检查项描述
    3. 具体要求
    4. 分值信息
    """

    return call_api(prompt_stage2)
```

### 方案6：后处理规则

```python
def post_process_checkpoints(checkpoints: list) -> list:
    """后处理：标准化检查点格式"""

    for cp in checkpoints:
        # 1. 统一分类名称
        category = cp.get('category', '')
        if '人员' in category and '分' in category:
            # 标准化为"人员要求(X分)"格式
            cp['category'] = normalize_category(category)

        # 2. 提取分值
        content = cp.get('content', '')
        score_match = re.search(r'(\d+)分', content)
        if score_match:
            cp['score'] = f"{score_match.group(1)}分"

        # 3. 补充缺失字段
        if 'id' not in cp:
            cp['id'] = generate_id()

    return checkpoints
```

## 📈 效果对比

| 指标 | 旧版本 | 优化版本V2 | 提升 |
|-----|--------|-----------|-----|
| 智谱AI提取数量 | 12个 | 预计15-18个 | +25% |
| 匹配检查点 | 0个 | 预计8-12个 | +∞ |
| 覆盖率 | 0% | 预计60-80% | +60% |
| 召回率 | 0% | 预计50-70% | +50% |

## 🎯 立即可用的改进

### 1. 运行优化版本

```bash
cd d:\interface_pytest\interface_pytest
python evaluate_checkpoints_with_claude_v2.py
```

### 2. 调整相似度阈值

```python
# 在 evaluate_checkpoints_with_claude_v2.py 中
threshold = 0.3  # 可调整为 0.2-0.5
```

- **0.2**：更宽松，更多匹配，但可能有误报
- **0.4**：更严格，更少匹配，但更准确

### 3. 使用更强模型

```python
# 修改配置文件
# evaluation_config.yaml
zhipuai_model: "glm-4-plus"  # 替代 "glm-4.7"
```

## 🔧 高级技巧

### 1. 温度参数调优

```python
# 提取任务使用低温度（更确定）
temperature = 0.1

# 如果需要更多样性，可以提高
temperature = 0.3
```

### 2. 分段处理大文档

```python
def split_and_process(document_text: str, chunk_size=5000):
    """分段处理长文档"""
    chunks = [document_text[i:i+chunk_size]
              for i in range(0, len(document_text), chunk_size)]

    all_checkpoints = []
    for i, chunk in enumerate(chunks):
        print(f"处理第 {i+1}/{len(chunks)} 段")
        checkpoints = extract_from_chunk(chunk)
        all_checkpoints.extend(checkpoints)

    return merge_duplicate_checkpoints(all_checkpoints)
```

### 3. 迭代优化

```python
def iterative_refinement(document_text, max_iterations=3):
    """迭代优化提取结果"""

    for iteration in range(max_iterations):
        print(f"第 {iteration + 1} 轮提取...")

        # 提取检查点
        checkpoints = extract_checkpoints(document_text)

        # 评估覆盖度
        coverage = calculate_coverage(document_text, checkpoints)

        if coverage > 0.85:  # 覆盖度阈值
            print(f"覆盖度达标: {coverage:.1%}")
            break

        # 如果覆盖度不够，针对性补充
        missing_parts = find_missing_parts(document_text, checkpoints)
        supplementary_prompt = f"""
        之前提取的检查点：
        {checkpoints}

        以下部分似乎被遗漏，请补充提取：
        {missing_parts}
        """
        additional_checkpoints = extract_checkpoints(supplementary_prompt)
        checkpoints.extend(additional_checkpoints)

    return checkpoints
```

## 📝 推荐工作流程

### 阶段1：快速验证（1天）
1. 运行 `evaluate_checkpoints_with_claude_v2.py`
2. 查看匹配结果
3. 调整相似度阈值

### 阶段2：Prompt优化（2-3天）
1. 添加Few-Shot示例
2. 调整分类体系
3. 测试不同模型

### 阶段3：系统优化（1周）
1. 实现多阶段提取
2. 添加后处理规则
3. 建立评估基准

## 🎓 最佳实践

### ✅ DO（推荐做法）
- ✅ 使用详细的Prompt说明
- ✅ 提供清晰的输出示例
- ✅ 保持原文术语和分类
- ✅ 使用多个相似度指标
- ✅ 人工校验提取结果
- ✅ 迭代优化Prompt

### ❌ DON'T（避免做法）
- ❌ 过度概括检查点
- ❌ 使用模糊的分类名称
- ❌ 忽略分值信息
- ❌ 只依赖单一匹配算法
- ❌ 使用过短的输入文本
- ❌ 一次性完成不迭代

## 📚 参考资源

- **智谱AI文档**：https://open.bigmodel.cn/dev/api
- **Prompt工程指南**：https://platform.openai.com/docs/prompt-engineering
- **文本相似度算法**：考虑使用BERT/RoBERTa等预训练模型

## 🔍 持续改进

建立反馈循环：

```
运行评估 → 分析结果 → 调整Prompt → 重新运行 → 对比提升
    ↑                                           ↓
    └─────────── 记录最佳实践 ───────────────────┘
```

---

**下一步**：运行 `evaluate_checkpoints_with_claude_v2.py` 查看改进效果！
