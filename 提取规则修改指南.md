# 智谱AI提取规则修改指南

## 📍 核心位置

**文件**：`evaluate_checkpoints_with_claude_v2.py`
**位置**：第 310-349 行

```python
# 3. 改进的Prompt
prompt = f"""你是一个招标文件评审专家。请仔细分析以下招标文件内容，提取所有具体的检查点和评审要求。

招标文件内容（前15000字符）：
```
{document_text}
```

请以JSON格式返回检查点，格式如下：
...
"""
```

---

## 🎯 可修改的提取规则

### 1️⃣ **提取粒度**（第335行）

```python
# 当前：细粒度提取
1. **细粒度提取**：尽量保持原文的具体表述，不要过度概括

# 改为：更细粒度（提取每个评分项）
1. **超细粒度提取**：提取每个具体的评分项和分档规则，保持完整原文

# 改为：中等粒度（概括主要项）
1. **中等粒度提取**：概括主要检查项，但保留关键信息
```

### 2️⃣ **分类体系**（第342-347行）

```python
# 当前：通用分类
**分类参考**：
- 封面检查、签字盖章
- 报价唯一性、资格要求
- 人员要求、企业业绩、企业资质
- 技术方案、服务承诺
- 履约能力、财务状况等

# 修改为：你的自定义分类
**分类参考**：
- 形式评审（封面、签字、格式）
- 资格评审（营业执照、资质证书、业绩）
- 技术评审（方案、人员、设备）
- 商务评审（报价、有效期、保证金）
- 其他（履约能力、财务状况）
```

### 3️⃣ **提取数量**（第339行）

```python
# 当前：10-20个
5. **数量控制**：提取主要检查点（10-20个）

# 改为：更多检查点
5. **数量控制**：提取所有检查点（15-25个）

# 改为：更少但更精准
5. **数量控制**：仅提取核心检查点（8-12个）
```

### 4️⃣ **输出字段**（第320-329行）

```python
# 当前格式
{{
  "id": "唯一编号",
  "category": "具体分类名称",
  "label": "检查项的简短描述",
  "content": "详细的检查要求说明",
  "importance": "高/中/低",
  "score": "分值（如果有）"
}}

# 添加自定义字段
{{
  "id": "唯一编号",
  "category": "具体分类名称",
  "label": "检查项的简短描述",
  "content": "详细的检查要求说明",
  "importance": "高/中/低",
  "score": "分值（如果有）",
  "page_number": "页码",           # 新增
  "check_method": "检查方法",      # 新增
  "penalty": "不符合的后果"        # 新增
}}
```

### 5️⃣ **提取重点**（第337行）

```python
# 当前：所有评分项
3. **提取所有评分项**：包括形式评审、资格评审、技术评审、商务评审等各个部分

# 改为：只提取特定类型
3. **提取重点检查项**：重点提取形式评审和资格评审部分

# 改为：增加要求
3. **提取所有评分项**：包括形式评审、资格评审、技术评审、商务评审等各个部分
   特别关注：有具体分值的项目、一票否决项、扣分项
```

### 6️⃣ **温度参数**（第76行）

```python
# 在 call_zhipuai_api_with_retry 函数中
response = client.chat.completions.create(
    model=model,
    messages=[...],
    temperature=0.1,  # 当前：低温度（更确定）
    max_tokens=8000
)

# 调整为：
temperature=0.3,   # 稍高温度（更多样化）
temperature=0.0,   # 最低温度（最确定）
```

---

## 📝 实战示例

### 示例1：要求提取分档规则

```python
prompt = f"""你是招标文件评审专家。

**特殊要求**：
1. 必须提取完整的分档规则（如：50万以下不得分，50-100万得1分）
2. 保留所有数字和分值信息
3. 标注每个检查项的分值

招标文件内容：
```
{document_text}
```

请提取..."""
```

### 示例2：添加Few-Shot示例

```python
prompt = f"""你是招标文件评审专家。

**提取示例**：

【示例1】
原文：具有ISO 9001质量管理体系认证证书，得1分；具有ISO 14001环境管理体系认证证书，得1分。

提取结果：
{{
  "id": "CP_001",
  "category": "企业资质(3分)",
  "label": "具有ISO 9001质量管理体系认证证书",
  "content": "具有ISO 9001质量管理体系认证证书，得1分；具有ISO 14001环境管理体系认证证书，得1分",
  "importance": "高",
  "score": "3分"
}}

**现在请分析以下招标文件**：
```
{document_text}
```

请按照上述示例提取..."""
```

### 示例3：要求提取一票否决项

```python
prompt = f"""你是招标文件评审专家。

**提取要求**：
1. **重点识别一票否决项**：如果未满足则直接废标的项
2. **标注重要性**：用"必须"、"一票否决"等关键词标识
3. **区分检查类型**：形式审查（必须项）、资格审查（否决项）、评分项

招标文件内容：
```
{document_text}
```

请提取..."""
```

---

## 🔧 快速修改步骤

### 步骤1：打开文件
```bash
# 使用你的编辑器打开
code evaluate_checkpoints_with_claude_v2.py
# 或
vim evaluate_checkpoints_with_claude_v2.py
```

### 步骤2：找到Prompt位置
搜索关键词：`# 3. 改进的Prompt`（约第310行）

### 步骤3：修改规则
根据上述示例修改对应部分

### 步骤4：保存并运行
```bash
python evaluate_checkpoints_with_claude_v2.py
```

### 步骤5：查看结果
```bash
python compare_results.py
```

---

## 📊 常见修改场景

### 场景1：提取结果太少

**问题**：只提取了8-10个检查点

**解决**：
```python
# 修改第339行
5. **数量控制**：提取主要检查点（20-30个）  # 增加数量

# 修改第335行
1. **细粒度提取**：提取每个具体的评分项，包括所有子项  # 更细粒度
```

### 场景2：分类不准确

**问题**：分类与实际不符

**解决**：
```python
# 修改第342-347行，添加你的分类
**分类参考**：
- 按你的招标文件分类（如：技术部分、商务部分、价格部分）
- 按评审阶段分类（如：资格预审、详细评审）
- 按检查性质分类（如：形式检查、实质检查）
```

### 场景3：丢失重要细节

**问题**：分档规则、扣分标准等丢失

**解决**：
```python
# 在第334-340行之间添加
**重点保留**：
1. 所有的分档规则（如：50-100万得1分）
2. 所有的扣分标准（如：每缺少一项扣2分）
3. 所有的特殊要求（如：一票否决、必须提供原件）
4. 所有的时间要求（如：2020年1月1日至今）
```

### 场景4：过度概括

**问题**：AI把具体要求概括成通用描述

**解决**：
```python
# 修改第335-336行
1. **细粒度提取**：完全保持原文表述，不要改写或概括
2. **保留原文术语**：必须使用招标文件中的原始词汇，包括专业术语

# 添加警告
**禁止**：
- 不要将具体分档概括为"符合要求"
- 不要将具体时间概括为"按时提供"
- 不要删减任何数字、分值、条件
```

---

## 🎨 高级技巧

### 技巧1：动态调整提取深度

```python
# 根据文档复杂度调整
if len(document_text) > 10000:
    extraction_depth = "提取主要检查点（15-20个）"
else:
    extraction_depth = "提取所有检查点（10-15个）"

prompt = f"""
...数量控制**：{extraction_depth}
"""
```

### 技巧2：多轮提取

```python
# 第一轮：粗提取
prompt1 = "识别所有提到'检查'、'要求'的段落"

# 第二轮：精细提取
prompt2 = "对识别的段落进行详细提取，包括分值、分档等"

# 第三轮：补充验证
prompt3 = "检查是否遗漏了带分值的项目"
```

### 技巧3：条件提取

```python
prompt = f"""
**提取规则**：
1. 如果分值 >= 5分，提取为"重要检查点"
2. 如果包含"必须"、"不得"，提取为"一票否决项"
3. 如果包含"扣分"，标注为"扣分项"
4. 其他提取为"一般检查点"
"""
```

---

## 📋 修改检查清单

在修改提取规则后，检查以下内容：

- [ ] 提取数量是否合适（15-25个）
- [ ] 分类是否准确
- [ ] 是否保留了分值信息
- [ ] 是否保留了分档规则
- [ ] 是否识别了一票否决项
- [ ] 是否保持了原文表述
- [ ] 输出格式是否正确
- [ ] JSON是否能正确解析

---

## 🚀 推荐的修改方案

基于你的数据特点，我推荐以下修改：

```python
prompt = f"""你是招标文件评审专家。请仔细分析以下招标文件内容，提取所有具体的检查点和评审要求。

招标文件内容（前15000字符）：
```
{document_text}
```

请以JSON格式返回检查点，格式如下：
```json
{{
  "checkpoints": [
    {{
      "id": "唯一编号",
      "category": "具体分类名称（保持原文，如：人员要求(6分)、企业业绩(8分)）",
      "label": "检查项的完整描述（保持原文表述，不要概括）",
      "content": "详细的检查要求说明，包括所有分档规则、扣分标准",
      "importance": "高/中/低",
      "score": "分值（如果有，如：6分）",
      "is_veto": "是否一票否决项（true/false）",
      "check_points": "具体的检查要点列表"
    }}
  ]
}}
```

**提取要求：**
1. **超细粒度提取**：提取每个具体的评分项，包括所有子项和分档
2. **完全保留原文**：不要改写、不要概括、不要删减任何信息
3. **保留所有数字**：包括分值、分档界线、时间期限、数量要求等
4. **标注分值**：如果检查项有分值，必须在score字段中标注
5. **识别特殊项**：标注一票否决项、扣分项、加 分项
6. **数量控制**：提取所有检查点（15-25个）
7. **只返回JSON**：不要其他解释文字

**分类规则**：
- 优先使用招标文件中的原始分类名称
- 保持分类中的分值信息（如：人员要求(6分)）
- 如果原文没有分类，根据内容归类

**必须保留的信息**：
- 所有的"得X分"、"扣X分"
- 所有的分档规则（如：50-100万得1分）
- 所有的时间要求（如：2020年1月1日至今）
- 所有的数量要求（如：不少于5名）
- 所有的"必须"、"不得"、"应当"等要求

请开始提取："""
```

---

## 📁 相关文件

- `evaluate_checkpoints_with_claude_v2.py` - 主文件（修改位置）
- `evaluate_checkpoints_with_claude.py` - 原版（参考）
- `test_data/evaluation/results/*.json` - 查看提取效果

---

**立即修改**：编辑 `evaluate_checkpoints_with_claude_v2.py` 的第310-349行！
